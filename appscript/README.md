# スプシ連携用 App Script

TameBot がリアクション集計結果とメンバー一覧を送信する先の API です。

## セットアップ

1. **スプレッドシートを作成**
   - [Google スプレッドシート](https://sheets.google.com) で新規作成

2. **Apps Script を開く**
   - 拡張機能 → Apps Script

3. **`Main.gs` の内容を貼り付け**
   - このリポジトリの `appscript/Main.gs` をコピーし、デフォルトの `Code.gs` を置き換え

4. **デプロイ**
   - デプロイ → 新しいデプロイ → 種類は「**ウェブアプリ**」
   - 説明: 任意（例: `TameBot 連携`）
   - **実行ユーザー**: 自分
   - **アクセス**: **「全員」**（※「Google アカウントを持つ全員」だと Bot からの匿名 POST で **401** になります）
   - デプロイをクリック

5. **URL を控える**
   - デプロイ後表示される「ウェブアプリの URL」をコピー
   - Bot の環境変数 `SPREADSHEET_API_URL` に設定

## シート構成

- **シート1**（名前は `SHEET1_NAME` またはリクエストの `sheet1Name`）
  - 1行目: メンバー名 | リアクション | ロール
  - 2行目以降: データ
  - リアクション: 個室🥂（A）/ 案内👔（B）/ サクラ🌸（C）/ 欠席❌ / 行けたら行く🙇（その他）/ 未入力🤔（複数ある場合は上記優先順で表示）

- **シート2**（名前は `SHEET2_NAME` または `sheet2Name`）
  - 1行目: 項目 | 値
  - 2行目以降: イケケモ, 案内, サクラ, スタッフ, ゲスト, インスタンス
  - 最後の行: 取得日時（JST、mm/dd hh:mm）

シートが無ければ自動作成されます。

## 401 が出る場合

- **「アクセス」を「全員」にしていない**と、Bot からの POST で 401 になります。
- デプロイの **編集**（鉛筆アイコン）→ **アクセス** を **「全員」** に変更 → **バージョン: 新バージョン** で再デプロイしてください。
- 「Google アカウントを持つ全員」は不可です。**「全員」**（匿名ユーザー含む）にしてください。

## デバッグ（データが反映されないとき）

### Bot 側で GAS のログを見る

1. Bot の環境変数に **`DEBUG_SPREADSHEET=1`** を設定して再デプロイ
2. リアクション集計を実行すると、GAS が受け取った処理の**各段階のログ**がレスポンスで返り、デプロイ先（Railway 等）のログに `[DEBUG_SPREADSHEET] ---------- GAS 側ログ ----------` 以下に表示されます
3. どこまで「OK」でどこで止まっているか確認できます

### GAS 側で実行ログを見る

- Apps Script エディタで **実行数**（左メニュー時計アイコン）を開く
- 直近の「doPost」実行をクリック → **ログ** タブで `Logger.log` の内容を確認できます
- 各ステップで `[GAS] ...` と出力しているので、失敗している箇所を特定できます

### よくある原因

- **別のスプレッドシートに書いている**: `getActiveSpreadsheet()` は **この Script を「拡張機能 → Apps Script」で開いたスプレッドシート** が対象です。データを反映したい**同じ**スプレッドシートから「拡張機能 → Apps Script」でプロジェクトを作成し、そのプロジェクトをデプロイしてください。
- デプロイ後も、**書き込み先は「Script を開いたあのスプレッドシート」**のままです。別のスプシに書きたい場合は、そのスプシで新規 Apps Script を作成するか、スプレッドシート ID を指定する実装に変更する必要があります。
