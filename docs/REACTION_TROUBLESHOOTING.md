# リアクション集計のトラブルシューティング

「トリガーには反応するが、メッセージにリアクションしたメンバーが取得できない」場合の確認事項です。

---

## 1. Discord Developer Portal（Bot 設定）

### 1.1 Privileged Gateway Intents（特権 Intent）

- **Server Members Intent**（`Guild Members`）: **オフのままでOK**
  - リアクションのユーザー取得には不要です。
- **Message Content Intent**: **オフのままでOK**
  - メッセージ本文の読み取りにのみ必要で、リアクション取得には不要です。

リアクション集計に特権 Intent は使いません。

---

## 2. Bot の招待時パーミッション（OAuth2 URL Generator）

**ここが最も重要です。** 「誰がリアクションしたか」を取るには、Bot に **メッセージ履歴の閲覧** 権限が必要です。

1. [Discord Developer Portal](https://discord.com/developers/applications) → 対象アプリ → **OAuth2** → **URL Generator**
2. **Scopes**: `bot`, `applications.commands` を選択
3. **Bot Permissions** で以下を**必ず**付与：
   - ✅ **View Channels**（チャンネルの閲覧）
   - ✅ **Read Message History**（メッセージ履歴の閲覧）← **必須**
   - ✅ **Send Messages**（結果投稿用）

4. 生成されたURLで** Bot を再招待**する
   - 既に招待済みでも、権限を足した場合は**新しい招待URLで再招待**しないと反映されません。

### 権限不足のときの典型的な症状

- トリガーリアクションは検知できる（`messageReactionAdd` は動く）
- `reaction.users.fetch()` やメッセージ取得で空・エラーになる、または 0 人になる

---

## 3. チャンネル／ロールの権限

- Bot のロールが、集計対象の**チャンネル**で **Read Message History** を許可されているか確認
- チャンネルごとの上書きで **Read Message History** が Deny になっていないか確認
  - サーバー設定 → チャンネル → 権限 → Bot のロール / @everyone

---

## 4. 絵文字（A / B / C）の一致

`.env` の `REACTION_A` / `REACTION_B` / `REACTION_C` が、実際にメッセージに付いている絵文字と**完全に一致**している必要があります。

### よくある不一致

- **Unicode の微妙な違い**
  - 例: `🅰️`（㊉ + 色）と `🅰`（㊉ のみ）は別扱い
  - Discord の `:champagne_glass:` などは、実際には `🥂` などの Unicode に対応
- **カスタム絵文字**
  - 別サーバーやクライアントの絵文字だと、Bot が参照できない・名前が違う場合あり
  - 使うなら、**Bot が所属しているサーバーの絵文字**に統一した方が安全

### 確認方法・ログから .env に合わせる

1. 環境変数 `DEBUG_REACTIONS=1` を設定して再デプロイする  
2. トリガーを付けて集計を実行し、ログの **「リアクション詳細ログ」** を確認する  
3. 各リアクションに **`→ .envにコピー可: REACTION_A=...`** のような行が出る  
   - この行を**そのままコピー**して `.env`（または Railway の Variables）に貼り、`REACTION_A` / `REACTION_B` / `REACTION_C` に反映する  
   - ログの値が Discord が実際に使っている `id` または `name` なので、**これに合わせれば一致**する  
4. 再デプロイ後に再度集計して、マッチするか確認する  
5. 不要になったら `DEBUG_REACTIONS` は削除するか `0` に戻してよい

---

## 5. トリガー・集計の流れ

- **トリガー**: 設定したトリガー絵文字（例: 📊）が、**集計対象のメッセージ**に付いたときに実行
- **集計対象**: その**同じメッセージ**に付いている A / B / C のリアクション
- トリガーを付けた**メッセージ**と、A/B/C が付いている**メッセージ**が別だと、集計は 0 人になります

---

## 6. デバッグログの見方

環境変数 **`DEBUG_REACTIONS=1`** を設定して再デプロイすると、リアクション集計時に **詳細ログ** が出ます。

### ログの内容

- **`---------- リアクション詳細ログ ----------`** … 詳細ログの開始
- **`メッセージ上のリアクション数: n`** … そのメッセージに付いているリアクションの種類数
- **`#1 id=... name=...`** … 各リアクションの実際の `id` / `name`。`[トリガー]` は集計トリガー用
- **`→ .envにコピー可: REACTION_A=...`** … **この行をそのままコピー**して `.env` や Railway の Variables に貼ると、実際に押されていた絵文字と一致する
- **`現在の設定: REACTION_A=...`** … いまの設定値（比較用）
- **`集計対象 マッチ状況 A=x B=y C=z`** … A/B/C にマッチした人数
- **`reaction.users.fetch() 失敗: ...`** … ユーザー取得でエラー（権限不足の可能性）

### 切り分け

- **「マッチ 0」「ユーザー 0」ばかり** → 絵文字不一致。ログの **`.envにコピー可`** の行をコピーして `REACTION_A` / `B` / `C` を上書きし、再デプロイ
- **`reaction.users.fetch()` 失敗** → **Read Message History** 不足を疑う（招待権限の見直し・再招待）

---

## 7. チェックリストまとめ

| 項目 | 確認内容 |
|------|----------|
| 招待時の Bot 権限 | `Read Message History` を付与し、**新しい招待URLで再招待**したか |
| チャンネル権限 | 集計するチャンネルで Bot に `Read Message History` が許可されているか |
| 絵文字 | `.env` の A/B/C が、実際に使っている絵文字（Unicode または ID）と一致しているか |
| 対象メッセージ | トリガーと A/B/C が**同じメッセージ**に付いているか |
| 特権 Intent | 使っていない（通常のままでOK） |

まずは **2. の招待権限** と **4. の絵文字** を重点的に確認すると原因に辿り着きやすいです。
